#!/bin/rc 

pname=$1
if(~ $1 '') {
	echo 'Usage: pkgbuild [package name]'
	exit bad_args
}

## THESE SHOULD GO AWAY
stylesdir=/9bps/styles ## SHOULD BECOME /sys/lib/9bps/styles ?
templatedir=/9bps/templates

template=$templatedir/$pname^.tpl

files=()
sums=()
style=mk

. $stylesdir/base
try . $template
. $stylesdir/$style

if(~ $wrksrc '') {
	wrksrc=$pkg-$version
}

targetarch=$objtype
if(! ~ $noarch '') {
	targetarch=noarch
}

fcache=/9bps/pkgcache
pkgbuild=/9bps/buildroot/$pkg-$version^_$rev
builddir=$pkgbuild/build
installdir=$pkgbuild/artifacts/install
tardir=$pkgbuild/artifacts/tar
packagedir=/9bps/pkg/$targetarch
rm -rf $pkgbuild
mkdir -p $pkgbuild
mkdir -p $fcache
mkdir -p $builddir
mkdir -p $installdir
mkdir -p $tardir
mkdir -p $packagedir
cd $builddir

if(test -f $packagedir/$pkg-$version^_$rev.pkg) {
	echo $pkg-$version $targetarch already built.
	exit already_built
}


echo BUILDING $pkg-$version^_$rev for $objtype

trystage fetch
trystage extract
trystage build

@{
	rfork nse
	#ls -l /9bps/unionfs
	if(! /9bps/unionfs -b -m / -c $installdir /) {
		echo UNIONFS FAILED
		exit failed_unionfs
	}
	bind -c '#e' /env
	bind '#d' /fd

	if(test -d $builddir/$wrksrc) {
		cd $builddir/$wrksrc
	}

	trystage install
}

trystage normalize

trystage package

rm -rf $pkgbuild
