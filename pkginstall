#!/bin/rc -e

pkgfile=$1

if(~ $pkgfile '') {
	echo Usage: pkginstall [pkgfile]
	exit no_pkgname
}

tmpcache=/tmp/pkg/
pkgcache=/sys/lib/pkg

#pkgfile=`{pkgfind $pkgname}
#if(~ $pkgfile '') {
#	exit no_package
#}
#pwd=`{pwd}
#pkgfile=$pwd/$pkgfile

#echo Found $pkgfile

if(! test -f $pkgfile) {
	echo $pkgfile does not exist.
	echo Usage: pkginstall [pkgfile]
	echo Example: pkginstall `{pkgfind git9}
	exit no_pkg
}

pkgname=`{echo $pkgfile | sed 's|.*/(.+)-([a-zA-Z0-9]+_[0-9]+).pkg|\1|g'}
#echo PKGNAME: $pkgname
#exit

mkdir -p $tmpcache/$pkgname
@{ cd $tmpcache/$pkgname && tar -xvzf $pkgfile }

fn sigexit {
	rm -r $tmpcache/$pkgname
}

## Validate package with metadata.
echo Validating $pkgname
. $tmpcache/$pkgname/meta

if(! ~ $pkg $pkgname) {
	echo $pkgfile contains package $pkg, not $pkgname.
	exit wrong_package
}

if(! ~ $arch $objtype) {
	if(! ~ $arch noarch) {
		echo $pkgfile contains a package for $arch, not $objtype
		exit wrong_arch
	}
}

## Check if we have already installed a package with this name.
if(test -d $pkgcache/$pkgname) {
	res=@{
		rfork e
		newversion=$version
		## TODO: Implement semver checking
		. $pkgcache/$pkgname/meta
		if(~ $newversion $version) {
			echo $pkg-$version already installed.
			exit already_installed
		}
	}
	if(! ~ $res '') {
		exit $res
	}	
}

# After we validate the package, install it into the cache.
mkdir -p $pkgcache/$pkgname
dircp $tmpcache/$pkgname $pkgcache/$pkgname

echo Unpacking $pkg-$version into /
cd /
tar -xvf $pkgcache/$pkgname/root.tar
