#!/bin/rc

echo 'RUNNING PKGBUILD'
exit 'running pkgbuild'

## THESE SHOULD GO AWAY
stylesdir=/usr/knusbaum/CodeBase/9bps/styles ## SHOULD BECOME /sys/lib/9bps/styles


template=/usr/knusbaum/CodeBase/9bps/unionfs.tpl
fcache=/tmp/pkgcache
pkgbuild=/tmp/pkgbuild
builddir=$pkgbuild/builddir
installdir=$pkgbuild/installdir
#distdir=$pkgbuild/distfiles
rm -rf $pkgbuild
mkdir -p $fcache
mkdir -p $builddir
mkdir -p $installdir
#mkdir -p $distdir
cd $builddir


files=()
sums=()
style=mk


. $template
. $stylesdir/$style
. $stylesdir/base

if(~ $wrksrc '') {
	wrksrc=$pkgname-$version
}

fn sha1 {
	sha1sum $* | awk '{print $1}'
}

fn extractfile {
	file=$1
	ret=''
	if(~ $file (*.tar.gz *.tgz)) {
		echo $file is a gzipped tarball.
		tar -xzf $file
		ret=$status
	}
	if(~ $file *.tar) {
		echo $file is a tarball.
		tar -xf $file
		ret=$status
	}
	status=$ret
}

fn fetch {
	for(n in `{seq 1 $#files}) {
		s=$sums($n)
		f=$files($n)
		basef=`{basename $f}

		if(test -f $fcache/$basef) {
			echo FILE $basef EXISTS
		}
		if not {
			echo FETCHING $basef
			if(! hget $f > $fcache/$basef) {
				echo Failed to fetch $f
				exit 'bad_fetch'
			}
			if not {
				echo Fetched $f to $fcache/$basef
			}
			sha=`{sha1 $fcache/$basef}
			if(! ~ $sha $s) {
				echo Expected sha1sum $s but $f has sum $sha
				exit 'bad_sha1sum'
			}
			if not {
				echo Sums match '(' $s ')'
			}
		}
	}
}

fn extract {
	cd $builddir
	if(! ~ $#files 1) {
		mkdir $builddir/$wrksrc
		cd $builddir/$wrksrc
	}

	for(n in `{seq 1 $#files}) {
		f=$files($n)
		basef=`{basename $f}
		if(! extractfile $fcache/$basef) {
			echo 'STATUS: ['$status']'
			echo Failed to extract $fcache/$basef
			exit 'failed_extract'
		}
		echo DONE EXTRACTING $fcache/$basef
	}
}

fn do_loudly {
	echo $1
	$1
	ret=$status
	echo DONE $1
	status=$ret
}

fn do_pre_post {
	do_loudly pre_$1
	do_loudly $1
	do_loudly post_$1
}

if(! do_pre_post fetch) {
	echo FETCH FAILED.
	exit failed_fetch
}

if(! do_pre_post extract) {
	echo EXTRACT FAILED.
	exit failed_extract
}

if(! cd $builddir/$wrksrc) {
	echo Couldn''t find wrksrc $builddir/$wrksrc
	echo 'wrksrc1 should probably be one of'
	ls $builddir
	exit no_wrksrc
}

if(! do_pre_post build) {
	echo BUILD FAILED.
	exit failed_build
}

#rfork ns
#rootspec=other rootdir=/root/usr/knusbaum/rootfs auth/newns rc -c '
ls -l /tmp/unionfs
if(! /tmp/unionfs -b -m / -c $installdir /) {
	echo UNIONFS FAILED
	exit failed_unionfs
}
ns
cd $builddir/$wrksrc
mk install
ls -l /sys/man/4/unionfs
ls -l /usr/knusbaum/bin/amd64/unionfs
#'

#if(! do_pre_post install) {
#	echo INSTALL FAILED.
#	exit failed_install
#}
